\section{Measurement Infrastructure}
\label{datasets}
For this study, we made careful choices about the measurement infrastructure.  These included which vantage points within a country to use, which servers to use as relays, and which method to use for geolocating IP addresses.

\subsection{Resources}
\subsubsection{Vantage Points}
To our knowledge, the publicly available traceroute datasets suitable for our goal are from iPlane~\cite{madhyastha2006iplane} and CAIDA (Center for Applied Internet Data Analysis)~\cite{caida}.  The iPlane project uses PlanetLab ~\cite{planetlab} nodes to run traceroutes to a random set of IP addresses that cover all BGP atoms.  This project also has historical data as far back as 2006.  Unfortunately, because iPlane uses PlanetLab nodes, which have been shown to mostly use the Global Research and Education Network (GREN), the traceroutes run from PlanetLab nodes will not be representative of typical Internet users' traffic paths~\cite{banerjee2004interdomain}.  The other publicly available dataset, from CAIDA, ran traceroutes from different vantage points around the world, but to randomized destination IP addresses that cover all /24s.  This is also not sufficient for what we wanted to measure because a typical Internet user is going to access a domain that will be locally resolved; the user will not input a specific IP address in their browser.  Therefore, we chose to run active measurements that would be most representative of an Internet user.  We chose to run DNS and traceroute measurements from RIPE Atlas probes, which are hosted all around the world and in many different settings, include home networks~\cite{ripe_atlas}.  The first advantage of using RIPE Atlas is that the probes can use the local DNS resolver, which would give us the best estimate of the traceroute destination.  The next advantage is that we can control the parameters of traceroute; we specified to use paris traceroute as well as conducting both ICMP and TCP traceroutes.  We discuss more of our parameter selection and methodology in Section~\ref{measure}.

Our study looks at the Alexa Top 100 domains in different countries, as well as the 3rd party domains that are requested as part of an original web request.  To obtain these 3rd party domains we {\tt curl} each of the Top 100 domains, but we must do so from within the country we are studying.  There is no current functionality to {\tt curl} from RIPE Atlas probes, so we established a VPN connection within each of these countries to {\tt curl} each domain and extract the 3rd party domains.

\subsubsection{Servers}
As one of our research goals is to quantify how well the use of an overlay network will help clients avoid surveillance, we need access to a set of relays.  We used eight Amazon EC2 instances, one in each geographic region (United States, Ireland, Germany, Singapore, South Korea, Japan, Australia, Brazil), as well as 4 VPS machines (France, Spain, Brazil, Singapore).  The conjunction of these two sets of machines allow us to evaluate surveillance avoidance with a geographically diverse set of relays.

\subsubsection{Geolocation Data}
Previous work has shown that there are fundamental challenges in deducing a geographic location from an IP address, despite using different methods such as DNS names of the target, network delay measurements, and host-to-location mapping in conjunction with BGP prefix information~\cite{padmanabhan2001investigation}.  Because the focus of this work is on measuring and avoiding surveillance, and not on geolocation algorithms, we used a pre-existing geolocation service.  According to the literature, Digital Envoy provides the most accuracy when geolocating routers, so we use that service in our measurements and the design of our system~\cite{huffaker2011geocompare}. \annie{edit this if we end up just using MaxMind.}

\subsection{Measurement Pipeline: Current Traffic Analysis}
Our methods for measuring where traffic paths go use the data-plane; we analyze the reported hops of traceroute measurements to find which countries are on the path from a client in Country X to a popular domain.  For this study, we used RIPE Atlas probes in Country X, specifically the set of probes that had unique ASes in the country.  The destinations for traceroutes are the Country X Alexa Top 100 domains, as well as the third party domains within the response bodies of the 100 domains.  There are three main steps to our measurement procedure: traceroute generation and collection, transformation of traceroutes to country-level paths, and path analysis.

{\bf Step 1.} The first step is to {\tt curl} each of the Country X Alexa Top 100 domains, and extract the third party domains from the response body.  These third party domains will each be fetched by the client when the original webpage is rendered in the browser.  Next, the RIPE Atlas probes in Country X will locally resolve each domain (and third party domain) by running a DNS measurement.  The local resolution is representative of a DNS response that an Internet user in Brazil would receive.  Once the DNS responses are received for all DNS measurements, the IP addresses are consolidated into a list of /24 subnets that cover the set of IP addresses; this is done because all IP addresses in a /24 network should geolocate to the same country.  The last part of this step is running traceroutes from the RIPE Atlas probes to a single IP address in each of the /24 subnets calculated from the DNS responses.  The measurements were run using paris traceroute and each (probe, destination IP) pair was used twice: once using ICMP traceroute and once using TCP traceroute.  

{\bf Step 2.}  Step 2 generates country-level paths from the set of traceroutes produced during Step 1.  Using MaxMind, each IP address was geolocated at a country granularity.  This resulted in a set of country-level paths.

{\bf Step 3.}  After calculating country-level paths, we perform different data analysis to find where traffic travels.  We look for countries that are on the path between the client and the destination.  These countries have the potential to conduct surveillance on the traffic of clients in Country X.  A different analysis can show the countries in which the path ends, representing where the content is hosted.  It's important to note that the destinations found in this study could change if the content is georeplicated in other countries.  On the otherhand, if it is not georeplicated, then the destination's country is unavoidable.  We study this more closely in Section X.  Lastly, we look at how much tromboning occurs - a tromboning path is one that starts and ends in Country X, but also traverses at least one other country.  These paths are interesting because they should not be exiting the country if the destination is in the country of origin.  

\subsection{Measurement Pipeline: Country Avoidance Analysis with Open Resolvers}

\subsection{Measurement Pipeline: Country Avoidance Analysis with Relays}

\subsection{Avoidability Metrics}

\subsection{Caveats}

\subsubsection{Geolocation Accuracy}
\annie{Discuss past comparisons and how this is it's own research area.  Discuss None entries in MaxMind and justify lower bound on results (None entries are counted as the country in question).}

\subsubsection{IPv4}
\annie{Discuss how our study just looks at IPv4 and not IPv6, which would likely lead to very different paths}

\subsubsection{Path Asymmetry}
\annie{Discuss asymmetry study here and also that our study shows a lower bound - potential surveillance could be worse (but not better).}
